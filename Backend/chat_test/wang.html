<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Wang</title>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <style>
            #history {
                width: 500px;
                height: 500px;
            }
            #chat-input {
                width: 450px;
            }
            #send {
                width: 50px;
            }
        </style>
    </head>
    <body>
        <div style="text-align: center">
            <textarea id="history" disabled="true"></textarea>
            <div>
                <input id="chat-input" type="text"/>
                <input id="send" type="button" value="send"/>
            </div>
        </div>
    </body>
    <script>
        // http requests
        $.ajax({
            url: 'http://localhost:8000/login/',
            method: 'post',
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            data: JSON.stringify({
                'username': 'professorWang',
                'password': '123456'
            }),
            success: function(data, _, header) {
                let token = header.getResponseHeader('token');
                let userId = data['data']['id'];
                let realname = data['data']['name'];
                // websocket request
                // receiver这里写死为liadrinz
                var mutex = true;
                let ws = new WebSocket(`ws://localhost:8000/ws/message/chat/?sender=${token}&receiver=1`);
                ws.onmessage = function (e) {
                    if (mutex) {
                        let data = JSON.parse(e.data);
                        let message = data['message'];
                        document.querySelector('#history').value += (message + '\n');
                    } else {
                        mutex = true;
                    }
                }
                ws.onclose = function (e) {
                    console.error('WS closes unexpectedly.');
                }
                document.querySelector('#chat-input').focus();
                document.querySelector('#chat-input').onkeyup = function (e) {
                    if (e.keyCode === 13) {
                        document.querySelector('#send').click();
                    }
                }
                document.querySelector('#send').onclick = function (e) {
                    let inputDom = document.querySelector('#chat-input');
                    let message = '王安生' + ': ' + inputDom.value;
                    ws.send(JSON.stringify({
                        'message': message,
                        'receiver_id': 1
                    }))
                    document.querySelector('#chat-input').value = '';
                    mutex = false;
                    document.querySelector('#history').value += (message + '\n');
                }
            }
        });
    </script>
</html>